/* Color Palette (Root Variables) */
:root {
    --color-dark-blue: #2c3e50;
    --color-background: #f0f2f5;
    --color-box-bg-white: #ffffff;
    --color-box-border-light: #e0e6ec;
    --color-text-dark: #34495e;

    --color-blue-primary: #3498db;
    --color-blue-secondary: #2980b9;

    --color-yellow-primary: #f1c40f;
    --color-yellow-secondary: #f39c12;

    --color-animated-line: #2ecc71;
    --color-label: #555;

    /* Responsive Layout Dimensions (Default for large screens) */
    --box-min-width: 180px; /* Slightly reduced default width */
    --box-min-height: 90px; /* Slightly reduced default height */
    --gap-horizontal: 60px; /* Reduced gap */
    --gap-vertical: 60px; /* Reduced gap */
}

/* Base styles for body and overall container */
body {
    font-family: 'Inter', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background-color: var(--color-background);
    margin: 0;
    color: var(--color-text-dark);
    overflow-x: hidden; /* Crucial: Prevent horizontal scroll for overflow */
    overflow-y: auto;
    padding: 15px; /* Reduced overall padding */
    box-sizing: border-box;
}

.pipeline-container {
    position: relative;
    padding: 30px 20px; /* Reduced container padding */
    background-color: var(--color-box-bg-white);
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
    max-width: 1300px; /* **Crucial:** Reduced max-width significantly */
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 500px; /* Adjusted min-height */
}

.pipeline-title {
    font-size: 2.2em; /* Slightly smaller title */
    color: var(--color-dark-blue);
    margin-bottom: 30px; /* Reduced margin */
    font-weight: 700;
}

/* Grid container for precise layout */
.pipeline-flow-grid {
    display: grid;
    /* Define grid columns based on variables */
    grid-template-columns: 
        minmax(var(--box-min-width), auto) /* Col 1: Document */
        var(--gap-horizontal) /* Col 2: Gap 1 */
        minmax(var(--box-min-width), auto) /* Col 3: Document Parsing */
        var(--gap-horizontal) /* Col 4: Gap 2 */
        minmax(var(--box-min-width), auto) /* Col 5: Segment-Level Annotation */
        var(--gap-horizontal) /* Col 6: Gap 3 (Branching) */
        minmax(var(--box-min-width), auto) /* Col 7: Tokenization / Element-Level Annotation */
        var(--gap-horizontal) /* Col 8: Gap 4 (Token Indexing / Text Segmentation) */
        minmax(var(--box-min-width), auto) /* Col 9: Token Indexing / Generate Embeddings */
        var(--gap-horizontal) /* Col 10: Gap 5 (Vector Indexing) */
        minmax(var(--box-min-width), auto) /* Col 11: Vector Indexing / Search */
        var(--gap-horizontal) /* Col 12: Gap 6 (Ranking) */
        minmax(var(--box-min-width), auto); /* Col 13: Ranking */
    
    /* Define grid rows based on variables */
    grid-template-rows: 
        auto /* Row 1: Top row (Tokenization, Token Indexing, Search, Ranking) */
        var(--gap-vertical) /* Row 2: Gap between top and middle row */
        auto /* Row 3: Middle row (main flow, Element-Level, Text Segmentation, Embeddings, Vector Indexing) */
        var(--gap-vertical) /* Row 4: Gap for loop */
        auto; /* Row 5: Bottom row for loop path */
        
    position: relative;
    width: 100%;
    align-items: start;
    justify-content: center;
    /* Optional: Show grid lines for debugging during development */
    /* background-color: rgba(255, 0, 0, 0.1); */
    /* border: 1px dashed red; */
}

/* Position each stage wrapper in the grid */
.pipeline-stage-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
}

/* Specific Grid Placements (adjust row/column spans as needed) */
/* Main flow on Row 3 */
#stage-wrapper-document { grid-column: 1; grid-row: 3; }
#stage-wrapper-parsing { grid-column: 3; grid-row: 3; }
#stage-wrapper-segment-annotation { grid-column: 5; grid-row: 3; }

/* Branching Top Row (Row 1) */
#stage-wrapper-tokenization { grid-column: 7; grid-row: 1; }
#stage-wrapper-token-indexing { grid-column: 9; grid-row: 1; }
#stage-wrapper-search { grid-column: 11; grid-row: 1; }
#stage-wrapper-ranking { grid-column: 13; grid-row: 1; }

/* Branching Middle Row (Row 3 for main flow) */
#stage-wrapper-element-annotation { grid-column: 7; grid-row: 3; }
#stage-wrapper-text-segmentation { grid-column: 9; grid-row: 3; }
#stage-wrapper-generate-embeddings { grid-column: 11; grid-row: 3; }
#stage-wrapper-vector-indexing { grid-column: 13; grid-row: 3; }


/* Base style for all pipeline boxes */
.pipeline-box {
    padding: 15px 20px; /* Reduced padding for smaller boxes */
    border-radius: 10px;
    text-align: center;
    font-weight: 600;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
    min-width: var(--box-min-width); /* Use variable for consistent width */
    min-height: var(--box-min-height); /* Use variable for consistent height */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    cursor: default;
}

.pipeline-box:hover {
    transform: translateY(-8px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
}

.box-label {
    font-size: 1em; /* Slightly smaller label font */
    line-height: 1.3;
}

/* Specific styles for different box types */
.document-box {
    background-color: var(--color-dark-blue);
    color: #fff;
    min-width: 200px; /* Adjusted width for Document */
    min-height: 160px; /* Adjusted height for Document */
    padding: 25px; /* Adjusted padding */
    border: none;
    justify-content: space-around;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
}

.document-text-lines {
    width: 65%;
    height: 50%;
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    margin-top: 5px;
}

.document-line {
    width: 90%;
    height: 4px; /* Thinner lines */
    background-color: rgba(255, 255, 255, 0.75);
    border-radius: 2px;
}

.document-line.short {
    width: 60%;
}

.process-box {
    background-color: var(--color-box-bg-white);
    border: 1px solid var(--color-box-border-light);
    color: var(--color-text-dark);
}

.data-box {
    color: #fff;
    font-weight: 700;
}

.data-box.blue-box {
    background-color: var(--color-blue-primary);
    border: 1px solid var(--color-blue-secondary);
}

.data-box.yellow-box {
    background-color: var(--color-yellow-primary);
    border: 1px solid var(--color-yellow-secondary);
    color: var(--color-text-dark); /* Dark text for readability on yellow */
}

/* Icon Styling */
.box-icon {
    font-size: 1.8em; /* Slightly smaller icon size */
    margin-bottom: 8px; /* Reduced margin */
    color: var(--color-text-dark);
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
}

.document-box .box-icon {
    color: #fff;
}

.data-box.yellow-box .box-icon {
    color: var(--color-text-dark);
}

/* Apply icon animation when box is faded in (via its wrapper) */
.pipeline-stage-wrapper.faded-in .box-icon {
    opacity: 1;
    transform: translateY(0);
}

/* SVG for lines and arrows */
.pipeline-lines {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    overflow: visible;
    z-index: 1; /* Lines are below boxes but above background */
}

.pipeline-line {
    stroke: var(--color-text-dark);
    stroke-width: 3;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
    opacity: 0.8;
    stroke-dasharray: 0;
    transition: stroke-dashoffset 1s ease-out;
}

/* Animation for the data flow effect */
.pipeline-line.animate {
    stroke: var(--color-animated-line);
    opacity: 1;
    animation: flow-pulse 1.5s infinite ease-in-out;
}

@keyframes flow-pulse {
    0% { opacity: 0.6; stroke-width: 3; }
    50% { opacity: 1; stroke-width: 4; }
    100% { opacity: 0.6; stroke-width: 3; }
}

/* SVG Arrowhead Styling */
.pipeline-lines defs {
    pointer-events: none;
}

.pipeline-lines marker {
    overflow: visible;
}

.arrowhead {
    fill: var(--color-text-dark);
    stroke: none;
    transition: fill 0.5s ease-in-out;
}

/* Deterministic Ranking Label */
.deterministic-ranking-label {
    position: absolute;
    bottom: 20px; /* Reduced bottom margin */
    font-weight: 700;
    color: var(--color-label);
    font-size: 1.2em; /* Slightly smaller label font */
    white-space: nowrap;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 1s ease-out, transform 1s ease-out;
    z-index: 10;
}

/* Responsive Adjustments */
/* Default values already set to be more compact */

@media (max-width: 1300px) {
    /* Main container max-width already handles this */
}

@media (max-width: 1100px) {
    .pipeline-flow-grid {
        grid-template-columns: 
            minmax(160px, auto) 40px minmax(160px, auto) 40px minmax(160px, auto) 40px
            minmax(160px, auto) 40px minmax(160px, auto) 40px minmax(160px, auto) 40px minmax(160px, auto);
    }
    :root {
        --box-min-width: 160px;
        --box-min-height: 80px;
        --gap-horizontal: 40px;
        --gap-vertical: 50px;
    }
    .document-box {
        min-width: 180px;
        min-height: 140px;
    }
    .box-icon {
        font-size: 1.5em;
    }
    .box-label {
        font-size: 0.9em;
    }
}

@media (max-width: 992px) {
    .pipeline-title {
        font-size: 2em;
        margin-bottom: 20px;
    }
    /* Switch to vertical stacking on smaller screens */
    .pipeline-flow-grid {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        padding-bottom: 0;
    }
    .pipeline-stage-wrapper {
        position: static !important;
        transform: none !important;
        opacity: 1 !important; /* Always visible in vertical layout for animations to start */
        margin-bottom: 30px; /* Space between vertical stages */
        width: auto;
    }
    .pipeline-box {
        min-width: 180px; /* Ensure boxes are readable in vertical stack */
        min-height: 90px;
        padding: 15px 20px;
    }
    .document-box {
        min-width: 200px;
        min-height: 160px;
    }
    .box-icon {
        font-size: 1.5em;
    }
    .box-label {
        font-size: 1em;
    }
    /* Hide SVG lines on vertical layout as they are hard to manage */
    .pipeline-lines {
        display: none;
    }
    .deterministic-ranking-label {
        font-size: 1.1em;
        bottom: 10px;
        padding: 0 10px;
    }
}

@media (max-width: 768px) {
    .pipeline-container {
        padding: 15px;
    }
    .pipeline-title {
        font-size: 1.8em;
    }
    .pipeline-box {
        min-width: 150px;
        min-height: 80px;
        padding: 12px 18px;
    }
    .document-box {
        min-width: 170px;
        min-height: 130px;
    }
    .box-icon {
        font-size: 1.3em;
    }
    .box-label {
        font-size: 0.9em;
    }
}

@media (max-width: 576px) {
    .pipeline-title {
        font-size: 1.4em;
    }
    .pipeline-box {
        min-width: 120px;
        min-height: 70px;
        padding: 10px 15px;
    }
    .document-box {
        min-width: 140px;
        min-height: 110px;
    }
    .box-icon {
        font-size: 1.1em;
    }
    .box-label {
        font-size: 0.8em;
    }
}
